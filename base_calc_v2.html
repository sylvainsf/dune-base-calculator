<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dune: Awakening - Base Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent: #f39c12; /* Dune-like orange */
            --accent-hover: #f7ab2f;
            --switch-purple: #a855f7; /* purple */
            --switch-purple-on: #7c3aed; /* darker purple when on */
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #1a1a1a;
            color: #f0e6d2;
        }
        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }
        .card {
            background-color: #2c2c2c;
            border: 1px solid #4a4a4a;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
        }
        .btn {
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s, transform 0.2s;
            border: none;
        }
    .btn-primary { background-color: var(--accent); color: #1a1a1a; }
    .btn-primary:not(:disabled):hover { background-color: var(--accent-hover); transform: translateY(-2px); }
    /* Accent text/border mapping */
    .text-d4ac0d { color: var(--accent) !important; }
    .border-d4ac0d { border-color: var(--accent) !important; }
    /* Deep Desert toggle button */
    .toggle-btn { border-width: 2px; border-style: solid; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .toggle-btn-on { background-color: var(--accent); color: #1a1a1a; border-color: var(--accent); }
    .toggle-btn-off { background-color: transparent; color: var(--accent); border-color: var(--accent); }
    .toggle-btn .switch { position: relative; width: 48px; height: 24px; border-radius: 9999px; border: 2px solid var(--accent); background: var(--switch-purple); }
    .toggle-btn-on .switch { background: var(--switch-purple-on); border-color: var(--accent); }
    .toggle-btn .knob { position: absolute; top: 50%; left: 4px; width: 20px; height: 16px; border-radius: 9999px; background: #ffffff; transform: translateY(-50%); transition: left 0.2s ease; }
    .toggle-btn-on .knob { left: calc(100% - 4px - 20px); }
        .btn-secondary {
            background-color: #4a4a4a;
            color: #f0e6d2;
        }
        .btn-secondary:not(:disabled):hover {
            background-color: #5a5a5a;
            transform: translateY(-2px);
        }
        .btn:disabled {
            background-color: #3a3a3a;
            color: #777;
            cursor: not-allowed;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2c2c2c; }
        ::-webkit-scrollbar-thumb { background: #4a4a4a; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #5a5a5a; }
        .modal-bg { background-color: rgba(0,0,0,0.7); }
    </style>
</head>
<body class="p-4 lg:p-8">

    <div class="max-w-screen-2xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl lg:text-5xl font-orbitron text-d4ac0d mb-2">Dune: Awakening</h1>
            <h2 class="text-2xl lg:text-3xl font-orbitron text-f0e6d2">Base Calculator</h2>
            <div class="mt-1 flex justify-center">
                <div class="font-orbitron text-center text-sm" style="color: var(--switch-purple); transform: scaleX(0.9); transform-origin: center;">
                    Brought to you by the guild Oblivion on Kadrish
                </div>
            </div>
            <div class="mt-4 flex flex-col sm:flex-row justify-center gap-3">
                <a href="https://donate.cancer.org/" target="_blank" rel="noopener noreferrer" class="btn btn-primary py-2 px-4 rounded-lg text-center">
                    If you like this tool, please consider supporting the American Cancer Society
                </a>
                <a href="https://github.com/sylvainsf/dune-base-calculator/issues/new/choose" target="_blank" rel="noopener noreferrer" class="btn btn-secondary py-2 px-4 rounded-lg text-center">
                    Got suggestions for improvements?
                </a>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Panel: Item Selection -->
            <div class="lg:col-span-2">
                <!-- Filters -->
                <div class="bg-gray-800 p-4 rounded-lg mb-6 shadow-lg flex flex-col sm:flex-row justify-between items-center gap-4 sticky top-4 z-10">
                    <div class="flex-grow w-full sm:w-auto">
                        <input type="text" id="search-input" placeholder="Search for items..." class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-d4ac0d" disabled>
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="tier-filter" class="font-bold text-lg">Tier:</label>
                        <select id="tier-filter" class="bg-gray-700 border border-gray-600 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-d4ac0d" disabled>
                            <option value="all">All Tiers</option>
                        </select>
                    </div>
                    <div class="flex gap-2 w-full sm:w-auto">
                        <button id="apartment-planner-btn" class="btn btn-primary py-2 px-4 rounded-lg flex-1 sm:flex-none" disabled>Apartment Planner</button>
                        <button id="pentashield-planner-btn" class="btn btn-secondary py-2 px-4 rounded-lg flex-1 sm:flex-none" disabled>Pentashield Planner</button>
                    </div>
                </div>

                <!-- Item Grid -->
                <div id="item-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 min-h-[400px] items-center justify-center bg-gray-900/50 rounded-lg p-8">
                    <div id="item-grid-placeholder" class="text-center col-span-full">
                         <h3 id="placeholder-title" class="text-gray-300 text-2xl font-orbitron mb-4">Loading Item Data...</h3>
                         <p id="placeholder-text" class="text-gray-400 text-lg mb-6">Attempting to load `items_data.json`.</p>
                         <p id="data-status" class="text-lg text-gray-400 mt-4 h-6"></p>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Materials List -->
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg sticky top-8 overflow-y-auto" style="max-height: calc(100vh - 2rem);">
                <!-- Deep Desert Toggle Button -->
                <div class="mb-4">
                    <button id="deep-desert-btn" class="w-full font-orbitron py-2 px-3 rounded-lg toggle-btn toggle-btn-on">
                        <span>Deep Desert</span>
                        <span class="switch"><span class="knob"></span></span>
                    </button>
                </div>
                <!-- Power Widget -->
                <div class="mb-6">
                    <h3 class="text-2xl font-orbitron text-d4ac0d mb-2 flex items-center gap-2"><span>‚ö°</span> Power Budget</h3>
                    <div class="flex items-center justify-between text-sm mb-2">
                        <div>
                            <span class="text-gray-300">Available:</span>
                            <span id="power-available" class="font-bold">0</span>
                        </div>
                        <div>
                            <span class="text-gray-300">Used:</span>
                            <span id="power-used" class="font-bold">0</span>
                        </div>
                        <div>
                            <span class="text-gray-300">Balance:</span>
                            <span id="power-balance" class="font-bold">0</span>
                        </div>
                    </div>
                    <div class="h-3 bg-gray-700 rounded relative overflow-hidden">
                        <div id="power-bar-available" class="absolute left-0 top-0 h-full" style="width: 0%; background-color: var(--accent)"></div>
                        <div id="power-bar-used" class="absolute left-0 top-0 h-full bg-red-500 opacity-80" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Water Capacity Widget -->
                <div class="mb-6">
                    <h3 class="text-2xl font-orbitron mb-2 flex items-center gap-2"><span>üíß</span> Water Capacity</h3>
                    <div class="flex items-center justify-between text-sm mb-2">
                        <div>
                            <span class="text-gray-300">Capacity (L):</span>
                            <span id="water-capacity" class="font-bold">0</span>
                        </div>
                    </div>
                    <div class="h-3 bg-gray-700 rounded relative overflow-hidden">
                        <div id="water-bar" class="absolute left-0 top-0 h-full" style="width: 0%; background-color: #3b82f6"></div>
                    </div>
                    <div class="mt-2 space-y-1 text-sm">
                        <div>
                            <span class="text-gray-300">Windtraps:</span>
                            <span id="water-windtrap-lpm" class="font-bold">0</span>
                            <span class="text-gray-300">L/min</span>
                        </div>
                        <div>
                            <span class="text-gray-300">Deathstills:</span>
                            <span id="water-deathstill-lph" class="font-bold">0</span>
                            <span class="text-gray-300">L/hour</span>
                        </div>
                    </div>
                </div>

                <!-- Consumables Auto-Calculation -->
                <div class="mb-6">
                    <h3 class="text-2xl font-orbitron mb-2 flex items-center gap-2"><span>‚õΩ</span> Consumables (Auto)</h3>
                    <label class="block text-sm text-gray-300 mb-1" for="consumable-days">Run equipment for:</label>
                    <div class="flex items-center gap-2 mb-3">
                        <input id="consumable-days" type="number" min="0" step="1" value="7" class="w-28 bg-gray-700 border border-gray-600 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-d4ac0d" />
                        <span class="text-gray-300">days</span>
                    </div>
                    <div id="consumables-list" class="space-y-2">
                        <p class="text-gray-500">No consumables added.</p>
                    </div>
                </div>

                

                <h3 class="text-2xl font-orbitron text-d4ac0d mb-4 border-b-2 border-d4ac0d pb-2">Required Materials</h3>
                <p id="deep-desert-note" class="text-sm text-gray-400 mb-4 italic">50% Deep Desert discount has been applied.</p>
                <div id="materials-list" class="space-y-2 pr-2">
                    <p class="text-gray-500">Add items to see required materials.</p>
                </div>
                <div class="mt-4">
                    <h4 class="text-lg font-orbitron text-d4ac0d mb-2">Selected Items</h4>
                    <div id="selected-items-list" class="space-y-1"></div>
                </div>
                <div class="mt-6 border-t-2 border-gray-700 pt-4 flex justify-between items-center">
                    <h4 class="text-xl font-bold">Total Items: <span id="total-items-count">0</span></h4>
                    <button id="reset-btn" class="btn btn-secondary py-2 px-4 rounded-lg">Reset All</button>
                </div>
                <!-- Export/Import -->
                <div class="mt-4 flex gap-3">
                    <button id="export-btn" class="btn btn-primary py-2 px-4 rounded-lg flex-1">Export</button>
                    <button id="import-btn" class="btn btn-secondary py-2 px-4 rounded-lg flex-1">Import</button>
                    <input id="import-file" type="file" accept="application/json" class="hidden" />
                </div>
            </div>
        </div>
    </div>

     <!-- Apartment Planner Modal -->
     <div id="apartment-modal" class="fixed inset-0 modal-bg z-40 items-center justify-center hidden">
          <div class="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-lg m-4">
                <h2 class="text-2xl font-orbitron text-d4ac0d mb-6">Apartment Planner</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div class="md:col-span-2">
                          <label for="num-people" class="block mb-2 font-semibold">Number of People (Apartments):</label>
                          <input type="number" id="num-people" min="1" value="1" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-d4ac0d">
                      </div>
                      <div>
                          <label for="plastone-per" class="block mb-2 font-semibold">Plastone per Apartment</label>
                          <input type="number" id="plastone-per" min="0" value="0" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-d4ac0d">
                      </div>
                      <div>
                          <label for="granite-per" class="block mb-2 font-semibold">Granite per Apartment</label>
                          <input type="number" id="granite-per" min="0" value="0" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-d4ac0d">
                      </div>
                      <div>
                          <label for="salvaged-per" class="block mb-2 font-semibold">Salvaged Metal per Apartment</label>
                          <input type="number" id="salvaged-per" min="0" value="0" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-d4ac0d">
                      </div>
                      <div>
                          <label for="iron-per" class="block mb-2 font-semibold">Iron per Apartment</label>
                          <input type="number" id="iron-per" min="0" value="0" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-d4ac0d">
                      </div>
                      <div>
                          <label for="agave-per" class="block mb-2 font-semibold">Agave Seeds per Apartment</label>
                          <input type="number" id="agave-per" min="0" value="0" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-d4ac0d">
                      </div>
                </div>
                <div class="mt-8 flex justify-end gap-4">
                     <button id="cancel-apartment" class="btn btn-secondary py-2 px-4 rounded-lg">Cancel</button>
                     <button id="add-apartment-mats" class="btn btn-primary py-2 px-4 rounded-lg">Apply</button>
                </div>
          </div>
     </div>

    <!-- Pentashield Planner Modal -->
    <div id="pentashield-modal" class="fixed inset-0 modal-bg z-40 items-center justify-center hidden">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-2xl m-4">
             <h2 class="text-2xl font-orbitron text-d4ac0d mb-4">Pentashield Planner</h2>
             <p class="text-sm text-gray-400 mb-4">Add one row per Pentashield. Vertical draws 6 power per square; Horizontal draws 3 power per square.</p>
             <div class="mb-3 flex justify-between items-center">
                 <button id="pent-add-row" class="btn btn-secondary py-1 px-3 rounded">+ Add Pentashield</button>
                 <div id="pent-summary" class="text-sm text-gray-300"></div>
             </div>
             <div id="pent-rows" class="space-y-2 max-h-[50vh] overflow-y-auto"></div>
             <div class="mt-6 flex justify-end gap-4">
                 <button id="cancel-pentashield" class="btn btn-secondary py-2 px-4 rounded-lg">Cancel</button>
                 <button id="add-pentashield-mats" class="btn btn-primary py-2 px-4 rounded-lg">Save</button>
             </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element Selection ---
            const dom = {
                // Data Management
                dataStatus: document.getElementById('data-status'),
                placeholderTitle: document.getElementById('placeholder-title'),
                placeholderText: document.getElementById('placeholder-text'),
                // Calculator UI
                itemGrid: document.getElementById('item-grid'),
                itemGridPlaceholder: document.getElementById('item-grid-placeholder'),
                materialsList: document.getElementById('materials-list'),
                deepDesertNote: document.getElementById('deep-desert-note'),
                selectedItemsList: document.getElementById('selected-items-list'),
                tierFilter: document.getElementById('tier-filter'),
                searchInput: document.getElementById('search-input'),
                totalItemsCount: document.getElementById('total-items-count'),
                resetBtn: document.getElementById('reset-btn'),
                exportBtn: document.getElementById('export-btn'),
                importBtn: document.getElementById('import-btn'),
                importFile: document.getElementById('import-file'),
                deepDesertBtn: document.getElementById('deep-desert-btn'),
                // Power UI
                powerAvailable: document.getElementById('power-available'),
                powerUsed: document.getElementById('power-used'),
                powerBalance: document.getElementById('power-balance'),
                powerBarAvailable: document.getElementById('power-bar-available'),
                powerBarUsed: document.getElementById('power-bar-used'),
                // Water UI
                waterCapacity: document.getElementById('water-capacity'),
                waterBar: document.getElementById('water-bar'),
                waterWindtrapLpm: document.getElementById('water-windtrap-lpm'),
                waterDeathstillLph: document.getElementById('water-deathstill-lph'),
                // Apartment Planner
                apartmentPlannerBtn: document.getElementById('apartment-planner-btn'),
                apartmentModal: document.getElementById('apartment-modal'),
                cancelApartmentBtn: document.getElementById('cancel-apartment'),
                addApartmentMatsBtn: document.getElementById('add-apartment-mats'),
                // Pentashield Planner
                pentashieldPlannerBtn: document.getElementById('pentashield-planner-btn'),
                pentashieldModal: document.getElementById('pentashield-modal'),
                cancelPentashieldBtn: document.getElementById('cancel-pentashield'),
                addPentashieldMatsBtn: document.getElementById('add-pentashield-mats'),
                pentAddRowBtn: document.getElementById('pent-add-row'),
                pentRows: document.getElementById('pent-rows'),
                pentSummary: document.getElementById('pent-summary'),
                // Consumables
                consumableDays: document.getElementById('consumable-days'),
                consumablesList: document.getElementById('consumables-list'),
                
                // Apartment fields
                aptNumPeople: document.getElementById('num-people'),
                aptPlastone: document.getElementById('plastone-per'),
                aptGranite: document.getElementById('granite-per'),
                aptSalvaged: document.getElementById('salvaged-per'),
                aptIron: document.getElementById('iron-per'),
                aptAgave: document.getElementById('agave-per'),
            };

            // --- State and Constants ---
            let allItems = [];
            let consumableCatalog = [];
            let selectedItems = {};
            // Mapping equipment name -> chosen consumable name
            let consumableChoice = {};
            let targetDays = 7;
            let apartmentConfig = { apartments: 0, per: { "Plastone": 0, "Granite": 0, "Salvaged Metal": 0, "Iron": 0, "Agave Seeds": 0 } };
            let pentashieldConfig = { entries: [] }; // entries: [{orientation:'vertical'|'horizontal', squares:number}]
            let pentWorking = null; // temp editor state
            const DEEP_DESERT_DISCOUNT = 0.5;
            let deepDesertEnabled = true;
            const TIER_METALS_ORDERED = ["copper", "iron", "steel", "aluminum", "duraluminum", "plastinium"];

            // --- Event Listeners ---
            dom.tierFilter.addEventListener('change', () => displayItems());
            dom.searchInput.addEventListener('input', () => displayItems());
            dom.resetBtn.addEventListener('click', resetCalculator);
            dom.itemGrid.addEventListener('click', handleItemGridClick);
            dom.apartmentPlannerBtn.addEventListener('click', () => dom.apartmentModal.classList.replace('hidden', 'flex'));
            dom.cancelApartmentBtn.addEventListener('click', () => dom.apartmentModal.classList.replace('flex', 'hidden'));
            dom.addApartmentMatsBtn.addEventListener('click', applyApartmentPlan);
            if (dom.pentashieldPlannerBtn) {
                dom.pentashieldPlannerBtn.addEventListener('click', openPentashieldModal);
            }
            if (dom.cancelPentashieldBtn) dom.cancelPentashieldBtn.addEventListener('click', () => dom.pentashieldModal.classList.replace('flex', 'hidden'));
            if (dom.addPentashieldMatsBtn) dom.addPentashieldMatsBtn.addEventListener('click', applyPentashieldPlan);
            if (dom.pentAddRowBtn) dom.pentAddRowBtn.addEventListener('click', () => { if (!pentWorking) pentWorking = []; pentWorking.push({orientation:'vertical', squares:0}); renderPentashieldEditor(); });
            if (dom.pentRows) dom.pentRows.addEventListener('input', handlePentashieldRowInput);
            if (dom.pentRows) dom.pentRows.addEventListener('change', handlePentashieldRowInput);
            if (dom.pentRows) dom.pentRows.addEventListener('click', handlePentashieldRowClick);
            if (dom.exportBtn) dom.exportBtn.addEventListener('click', exportStateToFile);
            if (dom.importBtn && dom.importFile) {
                dom.importBtn.addEventListener('click', () => dom.importFile.click());
                dom.importFile.addEventListener('change', handleImportFileChange);
            }
            if (dom.deepDesertBtn) {
                dom.deepDesertBtn.addEventListener('click', () => {
                    deepDesertEnabled = !deepDesertEnabled;
                    updateDeepDesertButtonState();
                    if (dom.deepDesertNote) dom.deepDesertNote.style.display = deepDesertEnabled ? '' : 'none';
                    updateMaterialsList();
                });
            }
            if (dom.consumableDays) {
                dom.consumableDays.addEventListener('input', () => {
                    const v = parseInt(dom.consumableDays.value, 10);
                    targetDays = isNaN(v) || v < 0 ? 0 : v;
                    renderConsumablesList();
                    
                });
            }
            if (dom.consumablesList) {
                // Handle per-equipment consumable selection changes
                dom.consumablesList.addEventListener('change', (e) => {
                    const sel = e.target.closest('select[data-equip]');
                    if (!sel) return;
                    const equip = sel.getAttribute('data-equip');
                    const value = sel.value;
                    if (equip && value) {
                        consumableChoice[equip] = value;
                        renderConsumablesList();
                    }
                });
            }
            
            // --- Data Loading ---
            function loadInitialData() {
                const xhr = new XMLHttpRequest();
                xhr.open('GET', `items_data.json?v=${new Date().getTime()}`, true);

                xhr.onprogress = function () {
                    updateDataStatus('Loading data...', false);
                };

                xhr.onload = function () {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        try {
                            updateDataStatus('Parsing data...', false);
                            const data = JSON.parse(xhr.responseText);
                            processAndInitializeData(data);
                        } catch (e) {
                            updateDataStatus(`Error parsing JSON: ${e.message}`, true);
                            dom.placeholderTitle.textContent = 'Error Loading Data';
                            dom.placeholderText.innerHTML = `Could not parse <code>items_data.json</code>. Ensure it is a valid JSON file.`;
                        }
                    } else {
                        updateDataStatus(`items_data.json not found (HTTP ${xhr.status}).`, true);
                        dom.placeholderTitle.textContent = 'No Data Found';
                        dom.placeholderText.innerHTML = `Run <code>get_data.py</code> to generate <code>items_data.json</code>, then refresh this page.`;
                    }
                };

                xhr.onerror = function () {
                    updateDataStatus('Could not load items_data.json.', true);
                    dom.placeholderTitle.textContent = 'No Data Found';
                    dom.placeholderText.innerHTML = `Run <code>get_data.py</code> to generate <code>items_data.json</code>, start a local server, then refresh.`;
                };
                
                xhr.send();
            }

            // --- Data Processing and UI Initialization ---
            function processAndInitializeData(data) {
                if (!Array.isArray(data)) {
                    updateDataStatus("Error: Loaded data is not a valid array.", true);
                    return;
                }
                
                allItems = data.filter(item => item.Recipe && Array.isArray(item.Recipe) && item.Recipe.length > 0 && !item.IsConsumable);
                allItems.forEach(item => {
                    item.CalculatedTier = getItemTier(item);
                });

                // Build consumable catalog from items' Consumables
                const cset = new Set();
                allItems.forEach(item => {
                    (item.Consumables || []).forEach(c => { if (c && c.Name) cset.add(c.Name); });
                });
                consumableCatalog = Array.from(cset).sort();

                populateTiers();
                displayItems();
                resetCalculator();
                
                // Enable UI
                dom.searchInput.disabled = false;
                dom.tierFilter.disabled = false;
                dom.apartmentPlannerBtn.disabled = false;
                if (dom.pentashieldPlannerBtn) dom.pentashieldPlannerBtn.disabled = false;
                dom.itemGridPlaceholder.classList.add('hidden');
                updateDataStatus(`Successfully loaded ${allItems.length} craftable items.`, false);
                updatePower();
                updateWater();
                // initialize Deep Desert note visibility
                if (dom.deepDesertNote) dom.deepDesertNote.style.display = deepDesertEnabled ? '' : 'none';
                
            }

            function updateDataStatus(message, isError = false) {
                dom.dataStatus.textContent = message;
                dom.dataStatus.style.color = isError ? '#f87171' : '#dc2626';
            }

            function getItemTier(item) {
                let highestTier = null;
                let highestTierIndex = -1;
                const searchStrings = [item.Name, ...(item.Recipe?.map(i => i.Name) || [])];

                for (const str of searchStrings) {
                    for (let i = TIER_METALS_ORDERED.length - 1; i >= 0; i--) {
                        const metal = TIER_METALS_ORDERED[i];
                        if (i > highestTierIndex && str.toLowerCase().includes(metal)) {
                            highestTier = metal;
                            highestTierIndex = i;
                        }
                    }
                }
                return highestTier ? highestTier.charAt(0).toUpperCase() + highestTier.slice(1) : "Basic";
            }

            // --- UI Population and Updates ---
            function populateTiers() {
                const tiers = ["Basic", ...TIER_METALS_ORDERED.map(t => t.charAt(0).toUpperCase() + t.slice(1))];
                dom.tierFilter.innerHTML = '<option value="all">All Tiers</option>';
                tiers.forEach(tier => {
                    const option = document.createElement('option');
                    option.value = tier;
                    option.textContent = tier;
                    dom.tierFilter.appendChild(option);
                });
            }

            // no consumable picker needed with auto-calc

            function displayItems() {
                dom.itemGrid.innerHTML = '';
                if (allItems.length === 0) {
                    dom.itemGrid.appendChild(dom.itemGridPlaceholder);
                    dom.itemGridPlaceholder.classList.remove('hidden');
                    return;
                }

                const selectedTier = dom.tierFilter.value;
                const searchTerm = dom.searchInput.value.toLowerCase();
                let filteredItems = allItems.filter(i => i.Name !== 'Pentashield');

                if (selectedTier !== 'all') filteredItems = filteredItems.filter(item => item.CalculatedTier === selectedTier);
                if (searchTerm) filteredItems = filteredItems.filter(item => item.Name.toLowerCase().includes(searchTerm));

                if (filteredItems.length === 0) {
                    dom.itemGrid.innerHTML = `<p class="text-gray-400 text-center col-span-full">No items match filters.</p>`;
                    return;
                }

                filteredItems.forEach(item => {
            const card = document.createElement('div');
                    card.className = 'card rounded-lg p-4 flex flex-col justify-between';
                    const recipeHtml = item.Recipe.map(mat => `<span>${mat.Name}: ${mat.Count}</span>`).join('<br>');
                    const waterRate = typeof item.WaterPerMinute === 'number' && item.WaterPerMinute > 0 ? item.WaterPerMinute : null;
                    const waterStr = (v) => {
                        if (v == null) return '';
                        return Math.ceil(v).toLocaleString();
                    };
                    let extraLine = '';
                    if (waterRate) {
                        const nm = (item.Name || '').toLowerCase();
                        if (nm.includes('deathstill')) {
                            const lph = waterRate * 60;
                            extraLine = `<div class=\"text-sm text-blue-300 mt-1\">üíß ${waterStr(lph)} L/hour</div>`;
                        } else {
                            extraLine = `<div class=\"text-sm text-blue-300 mt-1\">üíß ${waterStr(waterRate)} L/min</div>`;
                        }
                    }
                    card.innerHTML = `
                        <div>
                            <h4 class="text-xl font-bold font-orbitron text-f0e6d2">${item.Name}</h4>
                            <p class="text-sm text-gray-400 mb-2">Tier: ${item.CalculatedTier || 'N/A'}</p>
                            <div class="text-sm space-y-1 mb-1">${recipeHtml || 'No recipe found'}</div>
                            ${extraLine}
                        </div>
                        <div class="flex items-center justify-end gap-2 mt-auto">
                            <button class="btn btn-secondary w-8 h-8 rounded-full remove-item" data-item-name="${item.Name}">-</button>
                <span class="text-lg font-bold w-10 text-center item-count" data-item-name="${item.Name}">${selectedItems[item.Name] || 0}</span>
                            <button class="btn btn-primary w-8 h-8 rounded-full add-item" data-item-name="${item.Name}">+</button>
                        </div>`;
                    dom.itemGrid.appendChild(card);
                });
            }

            function updateMaterialsList() {
                const totalMaterials = {};
                Object.entries(selectedItems).forEach(([itemName, count]) => {
                    const itemData = allItems.find(i => i.Name === itemName);
                    if (itemData && count > 0) {
                        itemData.Recipe.forEach(material => {
                            totalMaterials[material.Name] = (totalMaterials[material.Name] || 0) + (material.Count * count);
                        });
                    }
                });

                // Add apartment-derived materials
                if (apartmentConfig.apartments > 0) {
                    Object.entries(apartmentConfig.per).forEach(([mat, perApt]) => {
                        const add = (parseInt(perApt, 10) || 0) * apartmentConfig.apartments;
                        if (add > 0) {
                            totalMaterials[mat] = (totalMaterials[mat] || 0) + add;
                        }
                    });
                }

                // Add Pentashield-derived materials: one recipe per entry
                if (pentashieldConfig.entries && pentashieldConfig.entries.length > 0) {
                    const pent = allItems.find(i => i.Name === 'Pentashield');
                    if (pent && Array.isArray(pent.Recipe)) {
                        const count = pentashieldConfig.entries.length;
                        pent.Recipe.forEach(material => {
                            const add = (material.Count || 0) * count;
                            if (add > 0) totalMaterials[material.Name] = (totalMaterials[material.Name] || 0) + add;
                        });
                    }
                }

                dom.materialsList.innerHTML = '';
                const sortedMaterials = Object.keys(totalMaterials).sort();
                if (sortedMaterials.length === 0) {
                    dom.materialsList.innerHTML = '<p class="text-gray-500">Add items to see required materials.</p>';
                } else {
                    sortedMaterials.forEach(matName => {
                        const baseAmount = totalMaterials[matName];
                        const amount = deepDesertEnabled ? Math.ceil(baseAmount * DEEP_DESERT_DISCOUNT) : baseAmount;
                        dom.materialsList.innerHTML += `<div class=\"flex justify-between items-center bg-gray-700 p-2 rounded\"><span>${matName}</span><span class=\"font-bold text-d4ac0d\">${amount.toLocaleString()}</span></div>`;
                    });
                }
                // Update selected items list
                dom.selectedItemsList.innerHTML = '';
                const entries = Object.entries(selectedItems).filter(([,count]) => count > 0);
                if (entries.length === 0) {
                    dom.selectedItemsList.innerHTML = '<p class="text-gray-500">No items selected.</p>';
                } else {
                    entries.sort((a,b) => a[0].localeCompare(b[0])).forEach(([name, count]) => {
                        const row = document.createElement('div');
                        row.className = 'flex justify-between items-center bg-gray-700 px-2 py-1 rounded';
                        // Compute per-item water output for this line (qty-aware) with unit based on item
                        const item = allItems.find(i => i.Name === name);
                        let waterText = '';
                        if (item && typeof item.WaterPerMinute === 'number' && item.WaterPerMinute > 0) {
                            const nm = (item.Name || '').toLowerCase();
                            if (nm.includes('windtrap')) {
                                const lpm = item.WaterPerMinute * count;
                                const s = Math.ceil(lpm).toLocaleString();
                                waterText = `<span class="text-xs text-blue-300">üíß ${s} L/min</span>`;
                            } else if (nm.includes('deathstill')) {
                                const lph = item.WaterPerMinute * 60 * count;
                                const s = Math.ceil(lph).toLocaleString();
                                waterText = `<span class="text-xs text-blue-300">üíß ${s} L/hour</span>`;
                            }
                        }
                        row.innerHTML = `<div class="flex flex-col"><span>${name}</span>${waterText}</div><span class="flex items-center gap-2"><span class="font-bold">${count}</span><button class="btn btn-secondary py-1 px-2 text-xs edit-count" data-name="${name}">‚úèÔ∏è</button></span>`;
                        row.querySelector('.edit-count').addEventListener('click', () => {
                            const current = selectedItems[name] || 0;
                            const val = prompt(`Set quantity for ${name}:`, String(current));
                            if (val === null) return;
                            const n = Math.max(0, parseInt(val, 10) || 0);
                            if (n === 0) delete selectedItems[name]; else selectedItems[name] = n;
                            updateMaterialsList();
                            displayItems();
                        });
                        dom.selectedItemsList.appendChild(row);
                    });
                }

                // Append Apartments count if set
                if (apartmentConfig.apartments > 0) {
                    const row = document.createElement('div');
                    row.className = 'flex justify-between items-center bg-gray-700 px-2 py-1 rounded';
                    row.innerHTML = `<span>Apartments</span><span class="font-bold">${apartmentConfig.apartments}</span>`;
                    dom.selectedItemsList.appendChild(row);
                }

                // Append Pentashield summary if set
                if ((pentashieldConfig.entries || []).length > 0) {
                    const row = document.createElement('div');
                    row.className = 'flex justify-between items-center bg-gray-700 px-2 py-1 rounded';
                    const totals = calcPentTotals();
                    const desc = `Pentashields x${totals.count} (Squares: ${totals.squares}, Power: -${totals.draw})`;
                    row.innerHTML = `<span>${desc}</span><span class="flex items-center gap-2"><button class="btn btn-secondary py-1 px-2 text-xs edit-pent">‚úèÔ∏è</button></span>`;
                    row.querySelector('.edit-pent').addEventListener('click', openPentashieldModal);
                    dom.selectedItemsList.appendChild(row);
                }

                dom.totalItemsCount.textContent = Object.values(selectedItems).reduce((sum, count) => sum + count, 0);
                updatePower();
                updateWater();
                // Initialize Deep Desert note and button style
                if (dom.deepDesertNote) dom.deepDesertNote.style.display = deepDesertEnabled ? '' : 'none';
                updateDeepDesertButtonState();
                renderConsumablesList();
            }

            function updatePower() {
                // Sum power provided and consumed
                let provides = 0;
                let consumes = 0;
                Object.entries(selectedItems).forEach(([itemName, count]) => {
                    const item = allItems.find(i => i.Name === itemName);
                    if (!item || count <= 0) return;
                    const p = (item.Power && typeof item.Power.Provides === 'number') ? item.Power.Provides : 0;
                    const c = (item.Power && typeof item.Power.Consumes === 'number') ? item.Power.Consumes : 0;
                    provides += p * count;
                    consumes += c * count;
                });

                // Pentashield special consumption: per-entry (vertical:6, horizontal:3) * squares
                if (pentashieldConfig && Array.isArray(pentashieldConfig.entries)) {
                    const extra = pentashieldConfig.entries.reduce((sum, e) => {
                        const sq = Math.max(0, parseInt(e?.squares, 10) || 0);
                        const per = (String(e?.orientation).toLowerCase() === 'horizontal') ? 3 : 6;
                        return sum + (sq * per);
                    }, 0);
                    consumes += extra;
                }

                dom.powerAvailable.textContent = provides;
                dom.powerUsed.textContent = consumes;
                const balance = provides - consumes;
                dom.powerBalance.textContent = balance;
                dom.powerBalance.style.color = balance < 0 ? '#f87171' : '#22c55e';

                // Normalize bar widths by the max of both
                const maxVal = Math.max(provides, consumes, 1);
                const availPct = Math.min(100, Math.round((provides / maxVal) * 100));
                const usedPct = Math.min(100, Math.round((consumes / maxVal) * 100));
                dom.powerBarAvailable.style.width = `${availPct}%`;
                dom.powerBarUsed.style.width = `${usedPct}%`;
                dom.powerBarUsed.style.opacity = consumes > provides ? '1' : '0.8';
            }

            function updateWater() {
                // Sum water capacities from selected items. If none have capacity, keep zero.
                let totalL = 0;
                // Also compute production totals (windtraps L/min, deathstills L/hour)
                let windtrapLpm = 0;
                let deathstillLph = 0;
                Object.entries(selectedItems).forEach(([itemName, count]) => {
                    const item = allItems.find(i => i.Name === itemName);
                    if (!item || count <= 0) return;
                    const cap = (typeof item.WaterCapacity === 'number') ? item.WaterCapacity : 0;
                    if (cap > 0) totalL += cap * count;

                    const rate = (typeof item.WaterPerMinute === 'number') ? item.WaterPerMinute : 0;
                    if (rate > 0) {
                        const nm = (item.Name || '').toLowerCase();
                        if (nm.includes('windtrap')) {
                            windtrapLpm += rate * count;
                        } else if (nm.includes('deathstill')) {
                            deathstillLph += rate * 60 * count; // convert to L/hour
                        }
                    }
                });
                dom.waterCapacity.textContent = totalL.toLocaleString();
                // Blue bar: normalize vs a soft cap for visualization. Use max of 10,000L or total.
                const denom = Math.max(10000, totalL, 1);
                const pct = Math.min(100, Math.round((totalL / denom) * 100));
                dom.waterBar.style.width = `${pct}%`;

                // Update production totals
                if (dom.waterWindtrapLpm) {
                    dom.waterWindtrapLpm.textContent = Math.ceil(windtrapLpm).toLocaleString();
                }
                if (dom.waterDeathstillLph) {
                    dom.waterDeathstillLph.textContent = Math.ceil(deathstillLph).toLocaleString();
                }
            }

            function updateDeepDesertButtonState() {
                if (!dom.deepDesertBtn) return;
                dom.deepDesertBtn.classList.remove('toggle-btn-on', 'toggle-btn-off');
                dom.deepDesertBtn.classList.add('toggle-btn', deepDesertEnabled ? 'toggle-btn-on' : 'toggle-btn-off');
            }

            function renderConsumablesList() {
                if (!dom.consumablesList) return;
                // Find selected equipment with consumable options
                const equip = Object.entries(selectedItems)
                    .map(([name, count]) => ({ name, count, item: allItems.find(i => i.Name === name) }))
                    .filter(x => x.item && x.count > 0 && Array.isArray(x.item.Consumables) && x.item.Consumables.length > 0);

                if (equip.length === 0) {
                    dom.consumablesList.innerHTML = '<p class="text-gray-500">No consumables required for the currently selected items.</p>';
                    return;
                }

                equip.sort((a,b) => a.name.localeCompare(b.name));
                const container = document.createElement('div');
                container.className = 'space-y-2';

                // Equipment rows with consumable picker
                equip.forEach(({ name, count, item }) => {
                    const options = (item.Consumables || []).filter(c => c && c.Name);
                    if (options.length === 0) return;
                    const validNames = new Set(options.map(o => o.Name));
                    if (!consumableChoice[name] || !validNames.has(consumableChoice[name])) {
                        const best = options.reduce((a,b) => (a.Hours||0) >= (b.Hours||0) ? a : b);
                        consumableChoice[name] = best.Name;
                    }
                    const row = document.createElement('div');
                    row.className = 'flex items-center justify-between bg-gray-700 p-2 rounded';
                    const left = document.createElement('div');
                    left.className = 'font-semibold';
                    left.textContent = `${name} x${count}`;
                    const right = document.createElement('div');
                    if (options.length > 1) {
                        const sel = document.createElement('select');
                        sel.className = 'bg-gray-700 border border-gray-600 rounded-md p-1 focus:outline-none focus:ring-2 focus:ring-d4ac0d';
                        sel.setAttribute('data-equip', name);
                        options.forEach(opt => {
                            const o = document.createElement('option');
                            o.value = opt.Name;
                            o.textContent = `${opt.Name} (${Math.ceil(opt.Hours || 0)}h)`;
                            if (opt.Name === consumableChoice[name]) o.selected = true;
                            sel.appendChild(o);
                        });
                        right.appendChild(sel);
                    } else {
                        right.innerHTML = `<span class="text-gray-300">${options[0].Name} (${Math.ceil(options[0].Hours || 0)}h)</span>`;
                        consumableChoice[name] = options[0].Name;
                    }
                    row.appendChild(left);
                    row.appendChild(right);
                    container.appendChild(row);
                });

                // Divider
                const divider = document.createElement('div');
                divider.className = 'border-t border-gray-700 my-2';
                container.appendChild(divider);

                // Totals based on chosen consumables
                const totals = {};
                equip.forEach(({ name, count, item }) => {
                    const chosen = consumableChoice[name];
                    const match = (item.Consumables || []).find(c => c && c.Name === chosen);
                    if (!match) return;
                    const hoursNeeded = (targetDays * 24) * count;
                    const hoursPerUnit = Math.max(0.001, match.Hours || 1);
                    const units = Math.ceil(hoursNeeded / hoursPerUnit);
                    totals[match.Name] = (totals[match.Name] || 0) + units;
                });
                const entries = Object.entries(totals).sort((a,b) => a[0].localeCompare(b[0]));
                if (entries.length === 0) {
                    const p = document.createElement('p');
                    p.className = 'text-gray-500';
                    p.textContent = 'No consumables required for the currently selected items.';
                    container.appendChild(p);
                } else {
                    entries.forEach(([cname, qty]) => {
                        const row = document.createElement('div');
                        row.className = 'flex items-center justify-between bg-gray-700 p-2 rounded';
                        row.innerHTML = `<span class="font-semibold">${cname}</span><span class="font-bold text-d4ac0d">${qty.toLocaleString()}</span>`;
                        container.appendChild(row);
                    });
                }

                dom.consumablesList.innerHTML = '';
                dom.consumablesList.appendChild(container);
            }

            
            
            // --- Event Handlers and Logic ---
            function resetCalculator() {
                selectedItems = {};
                // keep targetDays as user set
                consumableChoice = {};
                apartmentConfig = { apartments: 0, per: { "Plastone": 0, "Granite": 0, "Salvaged Metal": 0, "Iron": 0, "Agave Seeds": 0 } };
                pentashieldConfig = { count: 0, squares: 0 };
                if(allItems.length > 0) {
                    displayItems();
                }
                updateMaterialsList();
                renderConsumablesList();
                
            }

            function handleItemGridClick(e) {
                const target = e.target;
                const itemName = target.dataset.itemName;
                if (!itemName) return;

                if (target.classList.contains('add-item')) {
                    selectedItems[itemName] = (selectedItems[itemName] || 0) + 1;
                } else if (target.classList.contains('remove-item')) {
                    if (selectedItems[itemName] > 0) {
                        selectedItems[itemName]--;
                        if (selectedItems[itemName] === 0) delete selectedItems[itemName];
                    }
                }
                const safeName = CSS.escape(itemName);
                const countSpan = dom.itemGrid.querySelector(`.item-count[data-item-name="${safeName}"]`);
                if (countSpan) {
                    countSpan.textContent = selectedItems[itemName] || 0;
                }
                updateMaterialsList();
            }

            function applyApartmentPlan() {
                const people = parseInt(dom.aptNumPeople.value, 10) || 0;
                if (people <= 0) {
                    dom.apartmentModal.classList.replace('flex', 'hidden');
                    return;
                }
                // Update config
                apartmentConfig.apartments = people;
                apartmentConfig.per = {
                    'Plastone': parseInt(dom.aptPlastone.value, 10) || 0,
                    'Granite': parseInt(dom.aptGranite.value, 10) || 0,
                    'Salvaged Metal': parseInt(dom.aptSalvaged.value, 10) || 0,
                    'Iron': parseInt(dom.aptIron.value, 10) || 0,
                    'Agave Seeds': parseInt(dom.aptAgave.value, 10) || 0,
                };
                updateMaterialsList();
                dom.apartmentModal.classList.replace('flex', 'hidden');
            }

            function openPentashieldModal() {
                pentWorking = (pentashieldConfig && Array.isArray(pentashieldConfig.entries)) ? JSON.parse(JSON.stringify(pentashieldConfig.entries)) : [];
                renderPentashieldEditor();
                dom.pentashieldModal.classList.replace('hidden', 'flex');
            }

            function renderPentashieldEditor() {
                if (!dom.pentRows) return;
                dom.pentRows.innerHTML = '';
                const entries = pentWorking || [];
                let totalSquares = 0, totalDraw = 0;
                entries.forEach((e, idx) => {
                    const per = (String(e?.orientation).toLowerCase() === 'horizontal') ? 3 : 6;
                    const sq = Math.max(0, parseInt(e?.squares, 10) || 0);
                    totalSquares += sq;
                    totalDraw += (sq * per);
                    const row = document.createElement('div');
                    row.className = 'grid grid-cols-12 gap-2 items-center bg-gray-700 p-2 rounded';
                    row.innerHTML = `
                        <div class="col-span-5">
                            <label class="text-xs text-gray-300">Orientation</label>
                            <select data-idx="${idx}" data-field="orientation" class="w-full bg-gray-700 border border-gray-600 rounded-md p-1">
                                <option value="vertical" ${e.orientation==='vertical'?'selected':''}>Vertical (6/sq)</option>
                                <option value="horizontal" ${e.orientation==='horizontal'?'selected':''}>Horizontal (3/sq)</option>
                            </select>
                        </div>
                        <div class="col-span-4">
                            <label class="text-xs text-gray-300"># Squares</label>
                            <input data-idx="${idx}" data-field="squares" type="number" min="0" value="${sq}" class="w-full bg-gray-700 border border-gray-600 rounded-md p-1" />
                        </div>
                        <div class="col-span-2 text-sm text-gray-200 pent-row-power" data-idx="${idx}">Power: -${sq*per}</div>
                        <div class="col-span-1 flex justify-end"><button data-idx="${idx}" class="btn btn-secondary py-1 px-2 text-xs pent-remove">‚úñ</button></div>
                    `;
                    dom.pentRows.appendChild(row);
                });
                if (dom.pentSummary) dom.pentSummary.textContent = `Total: ${entries.length} units, ${totalSquares} squares, Power: -${totalDraw}`;
            }

            function handlePentashieldRowInput(e) {
                const idx = parseInt(e.target.getAttribute('data-idx'), 10);
                const field = e.target.getAttribute('data-field');
                if (isNaN(idx) || !field) return;
                if (!pentWorking || !pentWorking[idx]) return;
                if (field === 'orientation') pentWorking[idx].orientation = e.target.value === 'horizontal' ? 'horizontal' : 'vertical';
                if (field === 'squares') pentWorking[idx].squares = Math.max(0, parseInt(e.target.value, 10) || 0);
                // Update only the changed row's power and the summary; avoid re-render to preserve focus
                updatePentashieldRowPower(idx);
                updatePentashieldSummary();
            }

            function handlePentashieldRowClick(e) {
                const btn = e.target.closest('.pent-remove');
                if (!btn) return;
                const idx = parseInt(btn.getAttribute('data-idx'), 10);
                if (isNaN(idx)) return;
                if (!pentWorking) return;
                pentWorking.splice(idx, 1);
                renderPentashieldEditor();
            }

            function applyPentashieldPlan() {
                pentashieldConfig = { entries: Array.isArray(pentWorking) ? pentWorking.map(e => ({ orientation: (e.orientation==='horizontal'?'horizontal':'vertical'), squares: Math.max(0, parseInt(e.squares, 10) || 0) })) : [] };
                try {
                    updateMaterialsList();
                    updatePower();
                } finally {
                    // Always close even if an update throws
                    dom.pentashieldModal.classList.replace('flex', 'hidden');
                }
            }

            // Helper: compute Pentashield totals from saved config
            function calcPentTotals() {
                const entries = (pentashieldConfig && Array.isArray(pentashieldConfig.entries)) ? pentashieldConfig.entries : [];
                let squares = 0; let draw = 0; const count = entries.length;
                entries.forEach(e => {
                    const sq = Math.max(0, parseInt(e?.squares, 10) || 0);
                    const per = (String(e?.orientation).toLowerCase() === 'horizontal') ? 3 : 6;
                    squares += sq;
                    draw += sq * per;
                });
                return { count, squares, draw };
            }

            function updatePentashieldSummary() {
                if (!dom.pentSummary) return;
                const entries = pentWorking || [];
                let totalSquares = 0, totalDraw = 0;
                entries.forEach(e => {
                    const sq = Math.max(0, parseInt(e?.squares, 10) || 0);
                    const per = (String(e?.orientation).toLowerCase() === 'horizontal') ? 3 : 6;
                    totalSquares += sq;
                    totalDraw += sq * per;
                });
                dom.pentSummary.textContent = `Total: ${entries.length} units, ${totalSquares} squares, Power: -${totalDraw}`;
            }

            function updatePentashieldRowPower(idx) {
                const e = pentWorking && pentWorking[idx];
                if (!e) return;
                const per = (String(e?.orientation).toLowerCase() === 'horizontal') ? 3 : 6;
                const sq = Math.max(0, parseInt(e?.squares, 10) || 0);
                const el = dom.pentRows && dom.pentRows.querySelector(`.pent-row-power[data-idx="${idx}"]`);
                if (el) el.textContent = `Power: -${sq * per}`;
            }

            // --- Data File Management ---
            // (upload removed; JSON auto-loads if present)

            // --- Export / Import State ---
        function getExportState() {
                return {
                    version: 1,
                    savedAt: new Date().toISOString(),
                    deepDesertEnabled,
                    targetDays,
                    selectedItems,
                    consumableChoice,
            apartmentConfig,
            pentashieldConfig
                };
            }

            function exportStateToFile() {
                try {
                    const state = getExportState();
                    const json = JSON.stringify(state, null, 2);
                    const blob = new Blob([json], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    const d = new Date();
                    const yyyy = d.getFullYear();
                    const mm = String(d.getMonth() + 1).padStart(2, '0');
                    const dd = String(d.getDate()).padStart(2, '0');
                    a.href = url;
                    a.download = `dune_base_${yyyy}-${mm}-${dd}.json`;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 0);
                } catch (e) {
                    console.error('Export failed:', e);
                    alert('Export failed. See console for details.');
                }
            }

            function handleImportFileChange(evt) {
                const file = evt.target.files && evt.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = () => {
                    try {
                        const data = JSON.parse(reader.result);
                        applyImportedState(data);
                    } catch (e) {
                        console.error('Import failed:', e);
                        alert('Invalid JSON file.');
                    } finally {
                        dom.importFile.value = '';
                    }
                };
                reader.readAsText(file);
            }

            function applyImportedState(data) {
                if (!data || typeof data !== 'object') return;
                try {
                    // Deep Desert
                    if (typeof data.deepDesertEnabled === 'boolean') {
                        deepDesertEnabled = data.deepDesertEnabled;
                        updateDeepDesertButtonState();
                        if (dom.deepDesertNote) dom.deepDesertNote.style.display = deepDesertEnabled ? '' : 'none';
                    }
                    // Days
                    if (typeof data.targetDays === 'number' && isFinite(data.targetDays)) {
                        targetDays = Math.max(0, Math.floor(data.targetDays));
                        if (dom.consumableDays) dom.consumableDays.value = String(targetDays);
                    }
                    // Selected items
                    if (data.selectedItems && typeof data.selectedItems === 'object') {
                        selectedItems = {};
                        for (const [k,v] of Object.entries(data.selectedItems)) {
                            const n = Math.max(0, parseInt(v, 10) || 0);
                            if (n > 0) selectedItems[k] = n;
                        }
                    }
                    // Consumable choices
                    if (data.consumableChoice && typeof data.consumableChoice === 'object') {
                        consumableChoice = { ...data.consumableChoice };
                    }
                    // Apartments
                    if (data.apartmentConfig && typeof data.apartmentConfig === 'object') {
                        const a = data.apartmentConfig;
                        apartmentConfig = {
                            apartments: Math.max(0, parseInt(a.apartments, 10) || 0),
                            per: {
                                'Plastone': Math.max(0, parseInt(a?.per?.['Plastone'], 10) || 0),
                                'Granite': Math.max(0, parseInt(a?.per?.['Granite'], 10) || 0),
                                'Salvaged Metal': Math.max(0, parseInt(a?.per?.['Salvaged Metal'], 10) || 0),
                                'Iron': Math.max(0, parseInt(a?.per?.['Iron'], 10) || 0),
                                'Agave Seeds': Math.max(0, parseInt(a?.per?.['Agave Seeds'], 10) || 0),
                            }
                        };
                        // Reflect in modal fields
                        dom.aptNumPeople.value = String(apartmentConfig.apartments);
                        dom.aptPlastone.value = String(apartmentConfig.per['Plastone'] || 0);
                        dom.aptGranite.value = String(apartmentConfig.per['Granite'] || 0);
                        dom.aptSalvaged.value = String(apartmentConfig.per['Salvaged Metal'] || 0);
                        dom.aptIron.value = String(apartmentConfig.per['Iron'] || 0);
                        dom.aptAgave.value = String(apartmentConfig.per['Agave Seeds'] || 0);
                    }
                    // Pentashield (supports legacy {count,squares})
                    if (data.pentashieldConfig && typeof data.pentashieldConfig === 'object') {
                        const p = data.pentashieldConfig;
                        if (Array.isArray(p.entries)) {
                            pentashieldConfig = { entries: p.entries.map(e => ({ orientation: (String(e.orientation).toLowerCase()==='horizontal'?'horizontal':'vertical'), squares: Math.max(0, parseInt(e.squares, 10) || 0) })) };
                        } else {
                            const count = Math.max(0, parseInt(p.count, 10) || 0);
                            const squares = Math.max(0, parseInt(p.squares, 10) || 0);
                            if (count > 0) {
                                const per = Math.floor(squares / Math.max(1, count));
                                const entries = Array.from({length: count}, (_, i) => ({ orientation: 'vertical', squares: i === count - 1 ? (squares - per*(count-1)) : per }));
                                pentashieldConfig = { entries };
                            } else {
                                pentashieldConfig = { entries: [] };
                            }
                        }
                    }

                    // Refresh UI
                    displayItems();
                    // Update counts on cards
                    Object.entries(selectedItems).forEach(([name, count]) => {
                        const safe = CSS.escape(name);
                        const el = dom.itemGrid.querySelector(`.item-count[data-item-name="${safe}"]`);
                        if (el) el.textContent = count;
                    });
                    updateMaterialsList();
                } catch (e) {
                    console.error('Failed to apply imported state:', e);
                    alert('Failed to apply imported state.');
                }
            }

            // --- Kick off data load ---
            try {
                loadInitialData();
            } catch (e) {
                console.error('Failed to start data load:', e);
            }
        });
    </script>
</body>
</html>
